# RAG-Агент по ГОСТ Р 58669-2019

AI-агент на основе Retrieval-Augmented Generation (RAG) для ответа на вопросы по стандарту ГОСТ Р 58669-2019 "Единая энергетическая система и изолированно работающие энергосистемы. Релейная защита и автоматика. Трансформаторы тока измерительные. Требования к характеристикам намагничивания и методам их определения".

## Возможности

- Загрузка и обработка PDF и TXT документов из папки `files/`
- Поддержка документов ТТ (технических требований) из папки `files_TT/`
- Конвертация PDF в Markdown для улучшенной обработки формул
- Разделение текста на чанки с учетом структуры ГОСТ документов
- Векторное хранение с использованием FAISS
- Ответы на основе контекста с помощью модели Ollama (Qwen3:8b)
- Интерактивный чат в консоли и веб-интерфейсе
- Сохранение истории чатов
- Два режима работы: поиск информации и генерация ТТ

## Требования

- Python 3.8+
- Ollama (для запуска локальной модели)
- Зависимости Python: langchain, faiss-cpu, sentence-transformers, pymupdf, streamlit, python-docx, pdfplumber

## Установка

1. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```

2. Скачайте модель через Ollama:
   ```
   ollama pull qwen3:8b
   ```

3. Запустите Ollama сервер (в отдельном терминале):
   ```
   ollama serve
   ```

## Использование

### Подготовка документов

#### Конвертация PDF в Markdown (рекомендуется)
Для улучшения обработки формул и текста выполните конвертацию PDF файлов:
```
python convert_pdfs_to_markdown.py files/
```
Это создаст markdown версии документов в той же папке.

### Быстрый запуск с перестройкой индекса
Запустите файл `run.ps1` (для Windows) или `run.bat`:
```
# Очищает индекс и запускает python main.py
```

### Создание индексов без запуска интерфейса
```
python main.py --create-indexes
```

### Консольный интерфейс
Запустите:
```
python main.py
```
При первом запуске система автоматически обработает документы из папок `files/` и `files_TT/` и создаст векторные индексы.

Взаимодействие: Выберите режим 1 (Поиск) или 2 (Генерация ТТ), введите запрос.

Примеры вопросов:
- "Как определить точку насыщения трансформатора тока?"
- "Расскажи о методах расчета коэффициента насыщения"
- "Какие требования к вторичной нагрузке?"
- "Создай ТТ на трансформатор тока 10кВ"

Для выхода введите "exit".

### Веб-интерфейс
Запустите:
```
streamlit run app.py
```
Откроется веб-приложение с интерфейсом для поиска и генерации ТТ. Поддерживает сохранение истории чатов.

## Структура проекта

- `main.py` - основной скрипт агента (интерфейс выбора режима, поддержка --create-indexes)
- `search_handler.py` - модуль для поиска информации по нормативам
- `tt_handler.py` - модуль для генерации технических требований
- `app.py` - веб-интерфейс с Streamlit (с сохранением истории чатов)
- `convert_pdfs_to_markdown.py` - скрипт конвертации PDF в Markdown для улучшения обработки
- `requirements.txt` - зависимости Python
- `run.ps1` / `run.bat` - скрипты быстрого запуска с очисткой индекса
- `faiss_index/` - векторный индекс нормативных документов (создается автоматически)
- `faiss_index_tt/` - векторный индекс ТТ документов (создается автоматически)
- `files/` - папка с PDF и TXT документами нормативов
- `files_TT/` - папка с документами технических требований
- `chat_history.json` - сохраненная история чатов (создается автоматически)
- `activity.log` - лог работы системы

## Технические детали

- Эмбеддинги: `sentence-transformers/all-MiniLM-L6-v2` (с fallback на `distilbert-base-uncased`)
- Размер чанка: 1500 символов с перекрытием 300 (оптимизировано для ГОСТ документов)
- Разделители чанков: специальные разделители для структуры ГОСТ (разделы, подразделы)
- Поиск: MMR с k=7-10 (зависит от режима)
- Температура модели: 0.0 для поиска, 0.2 для генерации ТТ
- Ограничение ответа: до 300 слов для поиска, структурированный вывод для ТТ
- Извлечение ссылок: автоматическое определение разделов ГОСТ в чанках

## Дополнительные инструменты

### Конвертация PDF в Markdown
Скрипт `convert_pdfs_to_markdown.py` предназначен для предварительной обработки PDF документов:

- Использует `pdfplumber` для точного извлечения текста с формулами
- Корректирует поврежденные математические символы и формулы
- Создает markdown версии документов для улучшения RAG обработки
- Поддерживает пакетную обработку всех PDF в директории

Использование:
```
python convert_pdfs_to_markdown.py input_directory [output_directory]
```

### Скрипты запуска
- `run.ps1` - PowerShell скрипт для Windows (очищает индекс и запускает приложение)
- `run.bat` - Batch файл для Windows (вызывает PowerShell скрипт)

## Конфигурация

Для изменения параметров модели или промпта отредактируйте соответствующие файлы:

**main.py:**
- Имя модели Ollama: `qwen3:8b`
- Размер чанка и перекрытие в `RecursiveCharacterTextSplitter`
- Разделители для ГОСТ документов

**app.py:**
- Параметры цепочек RAG и TT
- Настройки интерфейса Streamlit
- Температура модели для разных режимов

**search_handler.py / tt_handler.py:**
- Шаблоны промптов для поиска и генерации ТТ
- Параметры поиска (k, lambda_mult)
